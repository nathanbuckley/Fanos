 # The Pico pwred solder fume fan 
 
from machine import Pin,  I2C, ADC
from ssd1306 import SSD1306_I2C
import utime

#     *** Screen Init ***
WIDTH = 128        # oled display width
HEIGHT = 32         # oled display height
i2c = I2C(0)                                                    # Init I2C defaults
print("Screen I2C Address : "+hex(i2c.scan()[0]).upper())       # Display device address
print("Screen I2C Configuration: "+str(i2c))                    # Display I2C config
oled = SSD1306_I2C(WIDTH, HEIGHT, i2c)                          # Init oled display
oled.fill(0)                                                    # Clear oled, clean slate

led = Pin(28, Pin.OUT)                                          # Indicator LED init 
led.low()
btn = Pin(19, Pin.IN, Pin.PULL_DOWN)                           # Button init
fana = Pin(14, Pin.OUT)                                        # Fan init
fanb = Pin(15, Pin.OUT)

def fanfwd():
    fana.low()
    fanb.high()
    
def fanstop():
    fana.low()
    fanb.low()
    
picoTempSensor = ADC(4)                                         # Connect to Internal Pico Internal Temp ADC
ConversionFactor = 3.3 / (65535)  

# Splash Screen 
spalshPxls = [[1, 1], [1, 2], [1, 3], [1, 4], [1, 5], [1, 6], [1, 7], [1, 8], [1, 9], [1, 10], [1, 11], [1, 12], [1, 13], [1, 14], [1, 15], [1, 16], [1, 17], [1, 18], [1, 19], [1, 20], [1, 21], [1, 22], [1, 23], [1, 24], [1, 25], [1, 26], [1, 27], [1, 28], [1, 29], [1, 30], [1, 31], [1, 32], [2, 1], [2, 11], [2, 21], [2, 31], [2, 32], [3, 1], [3, 11], [3, 15], [3, 16], [3, 17], [3, 21], [3, 31], [3, 32], [4, 1], [4, 11], [4, 14], [4, 15], [4, 16], [4, 17], [4, 18], [4, 21], [4, 31], [4, 32], [5, 1], [5, 11], [5, 14], [5, 15], [5, 16], [5, 17], [5, 18], [5, 21], [5, 31], [5, 32], [6, 1], [6, 11], [6, 13], [6, 14], [6, 15], [6, 16], [6, 17], [6, 18], [6, 19], [6, 21], [6, 31], [6, 32], [7, 1], [7, 11], [7, 14], [7, 15], [7, 16], [7, 17], [7, 18], [7, 21], [7, 31], [7, 32], [8, 1], [8, 11], [8, 14], [8, 15], [8, 16], [8, 17], [8, 18], [8, 21], [8, 31], [8, 32], [9, 1], [9, 11], [9, 15], [9, 16], [9, 17], [9, 21], [9, 31], [9, 32], [10, 1], [10, 11], [10, 21], [10, 31], [10, 32], [11, 1], [11, 2], [11, 3], [11, 4], [11, 5], [11, 6], [11, 7], [11, 8], [11, 9], [11, 10], [11, 11], [11, 12], [11, 13], [11, 14], [11, 15], [11, 16], [11, 17], [11, 18], [11, 19], [11, 20], [11, 21], [11, 22], [11, 23], [11, 24], [11, 25], [11, 26], [11, 27], [11, 28], [11, 29], [11, 30], [11, 31], [11, 32], [12, 1], [12, 11], [12, 21], [12, 31], [12, 32], [13, 1], [13, 11], [13, 21], [13, 25], [13, 26], [13, 27], [13, 31], [13, 32], [14, 1], [14, 11], [14, 21], [14, 24], [14, 25], [14, 26], [14, 27], [14, 28], [14, 31], [14, 32], [15, 1], [15, 11], [15, 21], [15, 24], [15, 25], [15, 26], [15, 27], [15, 28], [15, 31], [15, 32], [16, 1], [16, 11], [16, 21], [16, 23], [16, 24], [16, 25], [16, 26], [16, 27], [16, 28], [16, 29], [16, 31], [16, 32], [17, 1], [17, 11], [17, 21], [17, 24], [17, 25], [17, 26], [17, 27], [17, 28], [17, 31], [17, 32], [18, 1], [18, 11], [18, 21], [18, 24], [18, 25], [18, 26], [18, 27], [18, 28], [18, 31], [18, 32], [19, 1], [19, 11], [19, 21], [19, 25], [19, 26], [19, 27], [19, 31], [19, 32], [20, 1], [20, 11], [20, 21], [20, 31], [20, 32], [21, 1], [21, 2], [21, 3], [21, 4], [21, 5], [21, 6], [21, 7], [21, 8], [21, 9], [21, 10], [21, 11], [21, 12], [21, 13], [21, 14], [21, 15], [21, 16], [21, 17], [21, 18], [21, 19], [21, 20], [21, 21], [21, 22], [21, 23], [21, 24], [21, 25], [21, 26], [21, 27], [21, 28], [21, 29], [21, 30], [21, 31], [21, 32], [22, 1], [22, 11], [22, 21], [22, 31], [22, 32], [23, 1], [23, 5], [23, 6], [23, 7], [23, 11], [23, 15], [23, 16], [23, 17], [23, 21], [23, 25], [23, 26], [23, 27], [23, 31], [23, 32], [24, 1], [24, 4], [24, 5], [24, 6], [24, 7], [24, 8], [24, 11], [24, 14], [24, 15], [24, 16], [24, 17], [24, 18], [24, 21], [24, 24], [24, 25], [24, 26], [24, 27], [24, 28], [24, 31], [24, 32], [25, 1], [25, 4], [25, 5], [25, 6], [25, 7], [25, 8], [25, 11], [25, 14], [25, 15], [25, 16], [25, 17], [25, 18], [25, 21], [25, 24], [25, 25], [25, 26], [25, 27], [25, 28], [25, 31], [25, 32], [26, 1], [26, 3], [26, 4], [26, 5], [26, 6], [26, 7], [26, 8], [26, 9], [26, 11], [26, 13], [26, 14], [26, 15], [26, 16], [26, 17], [26, 18], [26, 19], [26, 21], [26, 23], [26, 24], [26, 25], [26, 26], [26, 27], [26, 28], [26, 29], [26, 31], [26, 32], [27, 1], [27, 4], [27, 5], [27, 6], [27, 7], [27, 8], [27, 11], [27, 14], [27, 15], [27, 16], [27, 17], [27, 18], [27, 21], [27, 24], [27, 25], [27, 26], [27, 27], [27, 28], [27, 31], [27, 32], [28, 1], [28, 4], [28, 5], [28, 6], [28, 7], [28, 8], [28, 11], [28, 14], [28, 15], [28, 16], [28, 17], [28, 18], [28, 21], [28, 24], [28, 25], [28, 26], [28, 27], [28, 28], [28, 31], [28, 32], [29, 1], [29, 5], [29, 6], [29, 7], [29, 11], [29, 15], [29, 16], [29, 17], [29, 21], [29, 25], [29, 26], [29, 27], [29, 31], [29, 32], [30, 1], [30, 11], [30, 21], [30, 31], [30, 32], [31, 1], [31, 2], [31, 3], [31, 4], [31, 5], [31, 6], [31, 7], [31, 8], [31, 9], [31, 10], [31, 11], [31, 12], [31, 13], [31, 14], [31, 15], [31, 16], [31, 17], [31, 18], [31, 19], [31, 20], [31, 21], [31, 22], [31, 23], [31, 24], [31, 25], [31, 26], [31, 27], [31, 28], [31, 29], [31, 30], [31, 31]]

for i in range(len(spalshPxls)):
    oled.pixel(spalshPxls[i][1] + 48, spalshPxls[i][0], 1)
oled.show()

utime.sleep(5)

fanOn = 0

def fanCtrl(pin):
    if btn() == 0:
        global fanOn
        if not fanOn:
            led.toggle()
            fanfwd()
            print("Fan on")
            fanOn = 1
        else:
            led.toggle()
            fanstop()
            print("Fan off")
            fanOn = 0
                
btn.irq(fanCtrl)

while True:
        
    # The temperature sensor measures the Vbe voltage of a biased bipolar diode, connected to the fifth ADC channel
    # Typically, Vbe = 0.706V at 27 degrees C, with a slope of -1.721mV (0.001721) per degree.  https://github.com/raspberrypi/pico-micropython-examples/blob/master/adc/temperature.py
    picoTemp = round(37 - ((picoTempSensor.read_u16() * ConversionFactor) - 0.706)/0.001721)
    
    print("Pico Temp: " + str(picoTemp))
    oled.fill(0) 
    oled.text("Fanny  v0.2", 15, 0)
    oled.text("----------------------", 0, 11)
    oled.text("Pico Temp: " + str(picoTemp), 0, 25)
    oled.show()
    utime.sleep(2)

